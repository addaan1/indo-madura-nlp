{% extends "base.html" %}

{% block content %}
<!-- Landing Section -->
<section id="landing" class="landing-section">
    <div class="landing-content">
        <div class="badge">:: OUR ECOSYSTEM</div>
        <h1 class="hero-title">
            UNLEASH THE POWER OF <br>
            <span class="gradient-text">Indo-Madura</span> <br>
            <span class="outlined-text">TRANSLATION</span>
        </h1>

        <div class="hero-description-box">
            <div class="line-decoration"></div>
            <p class="hero-description">
                "Bangun Jembatan Bahasa Indonesia dan Madura Lewat Model AI"
                <br><br>
                Proyek ini dibuat untuk menjembatani komunikasi antara Bahasa Indonesia dan Bahasa Madura
                menggunakan teknologi Neural Machine Translation tercanggih.
            </p>
        </div>

        <button class="launch-btn"
            onclick="document.getElementById('app-section').scrollIntoView({behavior: 'smooth'})">
            :: LAUNCH APP
        </button>
    </div>

    <!-- Decorative Background Elements -->
    <div class="grid-bg"></div>
    <div class="glow-orb orb-1"></div>
    <div class="glow-orb orb-2"></div>
</section>

<!-- App Section -->
<section id="app-section" class="app-section">
    <div class="container">
        <header class="app-header">
            <div class="logo-area">
                <i class="fa-solid fa-language logo-icon"></i>
                <h2>MODEL TRANSLASI</h2>
            </div>
        </header>

        <div class="glass-card">
            <!-- Controls -->
            <div class="controls">
                <div class="select-wrapper">
                    <select id="direction">
                        <option value="id_to_mad">INDONESIA &rarr; MADURA</option>
                        <option value="mad_to_id">MADURA &rarr; INDONESIA</option>
                    </select>
                    <i class="fa-solid fa-chevron-down select-icon"></i>
                </div>
            </div>

            <div class="translation-grid">
                <!-- Input Section -->
                <div class="text-area-wrapper input-wrapper">
                    <div class="area-header">
                        <span class="label">:: INPUT DATA</span>
                        <button id="micBtn" class="icon-btn" title="Rekam Suara">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                    </div>
                    <textarea id="inputText" placeholder="Masukkan teks atau merekam suara..."></textarea>
                    <div class="char-count">0 chars</div>
                    <div class="corner-decoration top-left"></div>
                    <div class="corner-decoration bottom-right"></div>
                </div>

                <!-- Action Section -->
                <div class="action-wrapper">
                    <button id="translateBtn" class="primary-btn">
                        <span>TERJEMAHKAN</span>
                        <i class="fa-solid fa-bolt"></i>
                    </button>
                </div>

                <!-- Output Section -->
                <div class="text-area-wrapper output-wrapper">
                    <div class="area-header">
                        <span class="label">:: OUTPUT DATA</span>
                        <button id="copyBtn" class="icon-btn" title="Salin Teks">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                    </div>
                    <textarea id="outputText" readonly placeholder="Hasil terjemahan..."></textarea>
                    <div class="corner-decoration top-right"></div>
                    <div class="corner-decoration bottom-left"></div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // --- UI Interactions ---
    const inputText = document.getElementById('inputText');
    const charCount = document.querySelector('.char-count');

    inputText.addEventListener('input', () => {
        charCount.textContent = `${inputText.value.length} chars`;
    });

    document.getElementById('copyBtn').addEventListener('click', () => {
        const outputText = document.getElementById('outputText');
        if (outputText.value) {
            navigator.clipboard.writeText(outputText.value);
            alert('Teks disalin!');
        }
    });

    // --- Translation Logic ---
    document.getElementById('translateBtn').addEventListener('click', async () => {
        const text = document.getElementById('inputText').value;
        const direction = document.getElementById('direction').value;
        const outputText = document.getElementById('outputText');
        const btn = document.getElementById('translateBtn');
        const btnIcon = btn.querySelector('i');

        if (!text.trim()) return;

        // Loading State
        btn.disabled = true;
        btn.classList.add('loading');
        outputText.classList.add('pulse');
        const originalText = btn.querySelector('span').textContent;
        btn.querySelector('span').textContent = "PROCESSING...";

        try {
            const response = await fetch('/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, direction }),
            });

            const data = await response.json();
            outputText.value = data.translated_text;
        } catch (error) {
            console.error('Error:', error);
            outputText.value = 'Error occurred during translation.';
        } finally {
            btn.disabled = false;
            btn.classList.remove('loading');
            outputText.classList.remove('pulse');
            btn.querySelector('span').textContent = originalText;
        }
    });

    // --- Audio Recording Logic ---
    const micBtn = document.getElementById('micBtn');
    const micIcon = micBtn.querySelector('i');
    let mediaRecorder;
    let audioChunks = [];

    micBtn.addEventListener('click', async () => {
        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
            // Start Recording
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendAudioToServer(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                micBtn.classList.add('recording');
                micIcon.className = 'fa-solid fa-stop';
                inputText.placeholder = "Listening...";
            } catch (err) {
                console.error("Error accessing microphone:", err);
                alert("Gagal mengakses mikrofon. Pastikan izin diberikan.");
            }
        } else {
            // Stop Recording
            mediaRecorder.stop();
            micBtn.classList.remove('recording');
            micIcon.className = 'fa-solid fa-microphone';
            inputText.placeholder = "Processing audio...";
        }
    });

    async function sendAudioToServer(audioBlob) {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.webm');

        inputText.value = "Transcribing audio...";
        inputText.disabled = true;

        try {
            const response = await fetch('/transcribe', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (data.transcribed_text) {
                inputText.value = data.transcribed_text;
                inputText.dispatchEvent(new Event('input'));
            } else {
                inputText.value = "Transcription failed.";
            }
        } catch (error) {
            console.error('Error uploading audio:', error);
            inputText.value = "Error uploading audio.";
        } finally {
            inputText.disabled = false;
            inputText.placeholder = "Masukkan teks atau merekam suara...";
        }
    }
</script>
{% endblock %}